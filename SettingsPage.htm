<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Anidownloader Settings</title>
        <link rel="icon" type="image/x-icon" href="/favicon.ico">
        <link rel="stylesheet" href="style.css">
    </head>

    <body style="background-color: #f7f8fa;">
        <section class="ftco-section goto-here pb-0">
            <div class="container">
                <h2 class="heading-section mb-2">AniDownloader web server</h2>
                <div class="row">
                    <div class="col-lg-12 mb-5 mb-md-0">
                        <div class="tabulation">
                            <ul class="nav nav-pills nav-fill d-md-flex d-block">
                            </ul>
                            <div class="tab-content rounded mt-md-3">
                                <div class="tab-pane container p-4 active">
                                    <h3 class="heading-section mb-3">Download Status</h3>
                                    <table class="table" id="currentDownloads">
                                        <thead>
                                            <tr>
                                                <th scope="col">Torrent ID</th>
                                                <th scope="col">Episode</th>
                                                <th scope="col">Status</th>
                                                <th scope="col">Progress</th>
                                            </tr>
                                        </thead>
                                        <tbody id="currentDownloads-body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="col-lg-12 mb-5 mb-md-0 align-items-center">
                    <h6>Current operation:</h6>
                    <h6 id="current-operation">none</h6>
                </div>
            </div>
        </section>
        <section class="ftco-section goto-here pb-0">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12 mb-5 mb-md-0">
                        <div class="tabulation">
                            <ul class="nav nav-pills nav-fill d-md-flex d-block">
                            </ul>
                            <div class="tab-content rounded mt-md-3">
                                <div class="tab-pane container p-4 active">
                                    <h3 class="heading-section mb-3">Series to Download</h3>
                                    <form method="post" action="update">
                                        ==========TABLE HERE===========
                                        <br>
                                        <button id="update">Send series table to the server</button>
                                    </form>
                                    <br>
                                    <button id="addRow" onclick="addRow()">Add Row</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="col-lg-12 mb-5 mb-md-0 align-items-center">
                    <h6>Offset adds an offset value to the episode numbers.</h6>
                    <h6>"Filter" is a Regular Expression that excludes matches.</h6>
                </div>
            </div>
        </section>

        <section class="ftco-section goto-here pb-0">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12 mb-5 mb-md-0">
                        <div class="tabulation">
                            <ul class="nav nav-pills nav-fill d-md-flex d-block">
                            </ul>
                            <div class="tab-content rounded mt-md-3">
                                <div class="tab-pane container p-4 active">
                                    <h2 class="heading-section mb-3">Program settings</h2>
                                    <form method="post" action="settings">
                                        <table id="Settings">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Setting</th>
                                                    <th scope="col">Value</th>
                                                </tr>
                                            </thead>
                                            <tbody id="Settings">
                                                <tr>
                                                    <td>Max File Size (MB)</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="number" name="MaxFileSizeMb" value="MaxFileSizeMb-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Delay for web requests</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="number" name="RPSDelayMs" value="RPSDelayMs-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Too few seeders Treshold</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="number" name="TooFewSeeders" value="TooFewSeeders-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Episode too old (days)</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="number" name="TooOldDays" value="TooOldDays-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Episode too new (minutes)</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="number" name="TooNewMinutes" value="TooNewMinutes-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Seeding time (hours)</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="number" name="SeedingTimeHours" value="SeedingTimeHours-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Seeding Ratio</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="SeedingRatio" value="SeedingRatio-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Use Seeding Ratio</td>
                                                    <td>
                                                        <select style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="UseRatio">
                                                            <option value="True" <!--UseRatioTrueSelected-->>True</option>
                                                            <option value="False" <!--UseRatioFalseSelected-->>False</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Exclude Batch Releases</td>
                                                    <td>
                                                        <select style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="ExcludeBatchReleases">
                                                            <option value="True" <!--ExcludeBatchReleasesTrueSelected-->>True</option>
                                                            <option value="False" <!--ExcludeBatchReleasesFalseSelected-->>False</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Enable Web Server</td>
                                                    <td>
                                                        <select style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="EnableWebServer">
                                                            <option value="True" <!--EnableWebServerTrueSelected-->>True</option>
                                                            <option value="False" <!--EnableWebServerFalseSelected-->>False</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Web server Port</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="WebserverPort" value="WebserverPort-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Listening IP</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="ListeningIP" value="ListeningIP-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Default Series Path</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="DefaultPath" value="DefaultPath-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Series Search Paths (Semicolon separated)</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="SearchPaths" value="SearchPaths-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Series Search Trigger Filename</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="NeedsConvertFileName" value="NeedsConvertFileName-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Uncensored Episodes Regex</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="UncensoredEpisodeRegex" value="UncensoredEpisodeRegex-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Filter by Custom Language</td>
                                                    <td>
                                                        <select style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="UseCustomLanguage">
                                                            <option value="True" <!--UseCustomLanguageTrueSelected-->>True</option>
                                                            <option value="False" <!--UseCustomLanguageFalseSelected-->>False</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Custom Language (Name) Regex</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="CustomLanguageNameRegex" value="CustomLanguageNameRegex-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Custom Language (Description) Regex</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="CustomLanguageDescriptionRegex" value="CustomLanguageDescriptionRegex-replace"></td>
                                                </tr>
                                                <tr>
                                                    <td>Use HWAccel in FFMpeg</td>
                                                    <td>
                                                        <select style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="UseTranscodingHWAccel">
                                                            <option value="True" <!--UseTranscodingHWAccelTrueSelected-->>True</option>
                                                            <option value="False" <!--UseTranscodingHWAccelFalseSelected-->>False</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Output Transcoding FFMpeg Commandline Arguments</td>
                                                    <td><input style="width:100%; padding:inherit; box-sizing:border-box;" type="text" name="OutputTranscodeCommandLineArguments" value="OutputTranscodeCommandLineArguments-replace"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <button id="update">Send settings to the server</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="col-lg-12 mb-5 mb-md-0 align-items-center">
                    <h6>The "Output Transcoding FFMpeg Commandline Arguments" setting follows the following usage:</h6>
                    <h6>FFMpeg -i "filetoConvert" -y OutputTranscodeCommandLineArguments "finalEpisodeName"</h6>
                    <h6>Only modify this parameter if you know what are you doing.</h6>
                </div>
            </div>
        </section>

        <script type="text/javascript">
            function addRow() {
                var tbody = document.getElementById("Series_Body");
                var rows = tbody.getElementsByTagName("tr");
                var maxIndex = -1;
                for (var i = 0; i < rows.length; i++) {
                    var id = rows[i].id;
                    if (id && id.startsWith("sr_")) {
                        var num = parseInt(id.substring(3), 10);
                        if (!isNaN(num) && num > maxIndex) {
                            maxIndex = num;
                        }
                    }
                }
                var rowNumber = maxIndex + 1;
                var element = '<tr id="sr_' + rowNumber + '">\
 <td><input style=\"width:105%; padding:inherit; box-sizing:border-box;\" type=\"text\" name=\"Name-'+ rowNumber + '\" value=\"\"/></td>\
 <td><input style=\"width:105%; padding:inherit; box-sizing:border-box;\" type=\"text\" name=\"Path-'+ rowNumber + '\" value=\"DefaultPath-replace\"/></td>\
 <td><input style=\"width:105%; padding:inherit; box-sizing:border-box;\" type=\"text\" name=\"Offset-'+ rowNumber + '\" value=\"0\"/></td>\
 <td><input style=\"width:105%; padding:inherit; box-sizing:border-box;\" type=\"text\" name=\"Filter-'+ rowNumber + '\" value=\"\"/></td>\
 <td><button id=\"del-' + rowNumber + '\" type=\"button\" onclick=\"deleteRow(' + rowNumber + ')\">x</button></td>\
    </tr>';
                tbody.innerHTML += element;
            }          

            function deleteRow(index) {
                var seriesBody = document.getElementById("Series_Body");
                var row = seriesBody.querySelector("#sr_" + index);
                if (row) {
                    row.remove();
                }
            }

            function updateTableContents(id) {
                (async () => {
                    let response = await fetch('./status');
                    let newHtml = await response.text();

                    // Create a temporary table to parse the new rows properly
                    let tempTable = document.createElement('table');
                    tempTable.innerHTML = '<tbody>' + newHtml + '</tbody>';
                    let newRows = Array.from(tempTable.querySelectorAll('tr'));

                    // Get existing tbody and rows
                    let tbody = document.getElementById(id);
                    let existingRows = Array.from(tbody.querySelectorAll('tr'));

                    // Map existing rows by unique key (using "Episode" from second <td>)
                    let existingMap = new Map();
                    existingRows.forEach(row => {
                        let key = row.querySelector('td:nth-child(2)')?.textContent.trim();
                        if (key) existingMap.set(key, row);
                    });

                    // Clear tempTable to avoid memory leaks
                    tempTable = null;

                    // Track seen keys for removal later
                    let seenKeys = new Set();

                    newRows.forEach(newRow => {
                        let key = newRow.querySelector('td:nth-child(2)')?.textContent.trim();
                        if (!key) return; // Skip invalid rows

                        seenKeys.add(key);

                        let existingRow = existingMap.get(key);
                        if (existingRow) {
                            // Update existing row: Compare and update cells if changed
                            let newCells = newRow.querySelectorAll('td');
                            let existingCells = existingRow.querySelectorAll('td');
                            for (let i = 0; i < existingCells.length; i++) {
                                if (existingCells[i].innerHTML !== newCells[i].innerHTML) {
                                    existingCells[i].innerHTML = newCells[i].innerHTML;
                                }
                            }
                        } else {
                            // Add new row
                            tbody.appendChild(newRow.cloneNode(true)); // Clone to avoid moving from temp
                        }
                    });

                    // Remove rows no longer present
                    existingRows.forEach(row => {
                        let key = row.querySelector('td:nth-child(2)')?.textContent.trim();
                        if (key && !seenKeys.has(key)) {
                            row.remove();
                        }
                    });
                })();
            }

            function updateCurrentOperation(id) {
                (async () => {
                    let response = await fetch('./currentoperation');
                    let termresult = await response.text();
                    document.getElementById(id).innerHTML = termresult;
                })()
            };


            (function () { //Auto-update the table every 300ms
                updateTableContents("currentDownloads-body");
                updateCurrentOperation("current-operation");
                setTimeout(arguments.callee, 300);
            })();

        </script>


    </body>
</html>
